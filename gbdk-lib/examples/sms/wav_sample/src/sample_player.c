#include "sample_player.h"

static const uint8_t voltable[768] = {
    0x9f,0xbf,0xdf, 0x9f,0xbf,0xdf, 0x9e,0xbf,0xdf, 0x9e,0xbf,0xdf, 0x9d,0xbf,0xdf, 0x9c,0xbf,0xdf, 0x9c,0xbf,0xdf, 0x9b,0xbf,0xdf,
    0x9a,0xbf,0xdf, 0x9a,0xbf,0xdf, 0x99,0xbf,0xdf, 0x99,0xbf,0xdf, 0x99,0xbf,0xdf, 0x98,0xbf,0xdf, 0x98,0xbf,0xdf, 0x98,0xbf,0xdf,
    0x98,0xbe,0xdf, 0x98,0xbe,0xdf, 0x98,0xbd,0xdf, 0x98,0xbc,0xdf, 0x98,0xbb,0xdf, 0x98,0xbb,0xdf, 0x98,0xba,0xdf, 0x98,0xba,0xdf,
    0x98,0xb9,0xdf, 0x98,0xb9,0xdf, 0x98,0xb8,0xdf, 0x98,0xb8,0xdf, 0x98,0xb8,0xdf, 0x98,0xb8,0xde, 0x98,0xb8,0xde, 0x98,0xb8,0xdd,
    0x98,0xb8,0xdc, 0x98,0xb8,0xdc, 0x98,0xb8,0xdb, 0x98,0xb8,0xda, 0x98,0xb8,0xda, 0x98,0xb8,0xd9, 0x98,0xb8,0xd9, 0x98,0xb8,0xd9,
    0x98,0xb8,0xd8, 0x98,0xb8,0xd8, 0x98,0xb8,0xd8, 0x97,0xb8,0xd8, 0x97,0xb8,0xd8, 0x97,0xb8,0xd8, 0x97,0xb7,0xd8, 0x97,0xb7,0xd8,
    0x97,0xb7,0xd8, 0x97,0xb7,0xd8, 0x97,0xb7,0xd7, 0x97,0xb7,0xd7, 0x97,0xb7,0xd7, 0x97,0xb7,0xd7, 0x96,0xb7,0xd7, 0x96,0xb7,0xd7,
    0x96,0xb7,0xd7, 0x96,0xb7,0xd7, 0x96,0xb6,0xd7, 0x96,0xb6,0xd7, 0x96,0xb6,0xd7, 0x96,0xb6,0xd7, 0x96,0xb6,0xd7, 0x96,0xb6,0xd6,
    0x96,0xb6,0xd6, 0x96,0xb6,0xd6, 0x96,0xb6,0xd6, 0x96,0xb6,0xd6, 0x95,0xb6,0xd6, 0x95,0xb6,0xd6, 0x95,0xb6,0xd6, 0x95,0xb6,0xd6,
    0x95,0xb6,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd6, 0x95,0xb5,0xd5,
    0x95,0xb5,0xd5, 0x95,0xb5,0xd5, 0x95,0xb5,0xd5, 0x95,0xb5,0xd5, 0x95,0xb5,0xd5, 0x94,0xb5,0xd5, 0x94,0xb5,0xd5, 0x94,0xb5,0xd5,
    0x94,0xb5,0xd5, 0x94,0xb5,0xd5, 0x94,0xb5,0xd5, 0x94,0xb5,0xd5, 0x94,0xb4,0xd5, 0x94,0xb4,0xd5, 0x94,0xb4,0xd5, 0x94,0xb4,0xd5,
    0x94,0xb4,0xd5, 0x94,0xb4,0xd5, 0x94,0xb4,0xd5, 0x94,0xb4,0xd4, 0x94,0xb4,0xd4, 0x94,0xb4,0xd4, 0x94,0xb4,0xd4, 0x94,0xb4,0xd4,
    0x94,0xb4,0xd4, 0x94,0xb4,0xd4, 0x94,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4,
    0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb4,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd4,
    0x93,0xb3,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd4, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3,
    0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x93,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3,
    0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3, 0x92,0xb3,0xd3,
    0x92,0xb3,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3,
    0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd3, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2,
    0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2, 0x92,0xb2,0xd2,
    0x92,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2,
    0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb2,0xd2, 0x91,0xb1,0xd2,
    0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2,
    0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd2, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1,
    0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1,
    0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x91,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1,
    0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1,
    0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb1,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1,
    0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1,
    0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1, 0x90,0xb0,0xd1,
    0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0, 0x90,0xb0,0xd0
};

void play_sample(uint8_t * sample, uint16_t size) NONBANKED NAKED {
    sample; size;
    __asm
        di
        push hl
        pop iy                              ; iy = hl

        ; set tone to 0
        ld c, #<_PSG
        xor a
        ld b, #(PSG_LATCH | PSG_CH0)        ; ch 0 tone 0
        out (c), b
        out (c), a
        ld b, #(PSG_LATCH | PSG_CH1)        ; ch 1
        out (c), b
        out (c), a
        ld b, #(PSG_LATCH | PSG_CH2)        ; ch 2
        out (c), b
        out (c), a

1$:
        ld hl, #_voltable
        ld b, #0
        ld c, 0(iy)
        inc iy
        add hl, bc
        add hl, bc
        add hl, bc                          ; hl = &_voltable[(sample[iy+0] * 3)]

        ld c, #<_PSG
        outi
        outi
        outi

        ld b, #22                           ; delay, need to be calculated properly
2$:
        djnz 2$

        dec de
        ld a, e
        or d
        jp nz, 1$

        ld a, #(PSG_LATCH | PSG_CH0 | PSG_VOLDDATA | 0x0f)  ; cut channel 1
        out (c), a
        ld a, #(PSG_LATCH | PSG_CH1 | PSG_VOLDDATA | 0x0f)  ; cut channel 2
        out (c), a
        ld a, #(PSG_LATCH | PSG_CH2 | PSG_VOLDDATA | 0x0f)  ; cut channel 3
        out (c), a

        ei
        in a, (_VDP_STATUS)  ; cancel pending VDP interrupts
        ret
    __endasm;
}
